(defun null. (x)
  (eq x '()))

(defun and. (x y)
  (cond (x (cond (y #t)
                 (#t #f)))
        (#t #f)))

(defun not. (x)
  (cond (x #f)
        (#t #t)))

(setq cons pair)

(defun append. (x y)
  (cond ((null. x) y)
        (#t (cons (car x)
                  (append. (cdr x) y)))))

(defun list. (x y)
  (cons x (cons y '())))

(defun zip. (x y)
  (cond ((and. (null. x) (null. y)) '())
        ((and. (not. (atom? x)) (not. (atom? y)))
         (cons (list. (car x) (car y))
               (zip. (cdr x) (cdr y))))))

(defun o (f g) (lambda (x) (f (g x))))
(setq caar (o car car))
(setq cadr (o car cdr))
(setq caddr (o cadr cdr))
(setq cadar (o car (o cdr car)))
(setq caddar (o car (o cdr (o cdr car))))


(defun lookup. (key alist)
  (cond ((null. alist) 'error)
        ((eq (caar alist) key) (cadar alist))
        (#t (lookup. key (cdr alist)))))

(defun eval. (e env)
   (letrec (
        (eval-cond. (lambda (c a)
            (cond ((null. c) 'error)
                  ((eval. (caar c) a)  (eval. (cadar c) a))
                  (#t (eval-cond. (cdr c) a)))))

        (map-eval. (lambda (exps env)
          (cond ((null. exps) '())
                (#t (cons (eval.  (car exps) env)
                          (map-eval. (cdr exps) env))))))
            )

      (cond
        ((sym? e) (lookup. e env))
        ((atom? e) e)
        ((atom? (car e))
         (cond
           ((eq (car e) 'quote) (cadr e))
           ((eq (car e) 'atom?) (atom? (eval. (cadr e)  env)))
           ((eq (car e) 'eq)    (eq    (eval. (cadr e)  env)
                                       (eval. (caddr e) env)))
           ((eq (car e) 'car)   (car   (eval. (cadr e)  env)))
           ((eq (car e) 'cdr)   (cdr   (eval. (cadr e)  env)))
           ((eq (car e) 'cons)  (cons  (eval. (cadr e)  env)
                                       (eval. (caddr e) env)))
           ((eq (car e) 'cond)  (eval-cond. (cdr e) env))
           ((eq (car e) '+)     (+ (eval. (cadr e) env)
                                   (eval. (caddr e) env)))
           ((eq (car e) '*)     (* (eval. (cadr e) env)
                                   (eval. (caddr e) env)))
           ((eq (car e) '-)     (- (eval. (cadr e) env)
                                   (eval. (caddr e) env)))
           ((eq (car e) '<)     (< (eval. (cadr e) env)
                                   (eval. (caddr e) env)))
           (#t (eval. (cons (lookup. (car e) env)
                            (cdr e))
                      env))))
        ((eq (caar e) 'label)
         (eval. (cons (caddar e) (cdr e))
                (cons (list. (cadar e) (car e)) env)))
        ((eq (caar e) 'lambda)
         (eval. (caddar e)
                (append. (zip. (cadar e)
                               (map-eval. (cdr e) env))
                         env))))))

(eval. '((label fact
                (lambda (x)
                  (cond ((< x 2) 1)
                        (#t (* x (fact (- x 1)))))))
         5)
       '())
